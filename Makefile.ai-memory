# Memory utility targets extracted from Makefile.ai-misc
# This file contains all ai-memory-* targets for memorydb and graph operations

ai-memory-utils-build:
	docker build -f Dockerfile.memory-utils -t memory-utils .

ai-memory-add-node:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_add_node.sh $(NAMESPACE) $(CONTENT) $(EMBEDDING) $(META)

ai-memory-add-edge:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_add_edge.sh $(FROM_ID) $(TO_ID) $(REL_TYPE) $(META)

ai-memory-list-nodes:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_list_nodes.sh

ai-memory-list-edges:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_list_edges.sh

ai-memory-traverse-single-hop:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_traverse_single_hop.sh $(NODE_ID)

ai-memory-traverse-multi-hop:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_traverse_multi_hop.sh $(NODE_ID)

ai-memory-traverse-by-relation:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_traverse_by_relation.sh $(NODE_ID) $(REL_TYPE)

ai-memory-export-dot:
	docker run --rm --network=host -v $(PWD)/scripts:/scripts memory-utils /scripts/memory_export_dot.sh > graph.dot

ai-memory-delete-nodes:
	@if [ -z "$(NAMESPACE)" ]; then \
	  echo 'Deleting ALL memory nodes!'; \
	  curl -X DELETE http://localhost:9103/memory/nodes; \
	else \
	  echo 'Deleting memory nodes in namespace: $(NAMESPACE)'; \
	  curl -X DELETE "http://localhost:9103/memory/nodes?namespace=$(NAMESPACE)"; \
	fi

ai-memory-create:
	@if [ -z "$(NAME)" ] || [ -z "$(OBSERVATION)" ] || [ -z "$(NAMESPACE)" ]; then \
		echo "[ERROR] Usage: make -f Makefile.ai ai-memory-create NAME=\"...\" OBSERVATION=\"...\" [PROJECT=\"...\"] [NAMESPACE=\"...\"]"; \
		exit 1; \
	fi
	@echo "[ai-memory-create] Creating memory: $(NAME)"
	@python3 scripts/create_memory.py --name "$(NAME)" --observation "$(OBSERVATION)" --project "$(PROJECT)" --namespace "$(NAMESPACE)"

ai-memory-log-git-diff:
	@DIFF_RANGE=$${DIFF_RANGE:-HEAD~1..HEAD}; \
	CONCISE_FLAG=$${CONCISE:-0}; \
	NAME=$${NAME:-"git-diff-$$DIFF_RANGE-`date +%Y%m%d-%H%M%S`"}; \
	OBSERVATION=$${OBSERVATION:-"Code changes for $$DIFF_RANGE summarized by LLM."}; \
	NAMESPACE=$${NAMESPACE:-"ai-ide-api"}; \
	mkdir -p diffs; \
	DIFF_FILE=diffs/$$NAME.diff; \
	DIFF=$$(git diff $$DIFF_RANGE); \
	if [ -z "$$DIFF" ]; then echo "[ai-memory-log-git-diff] No changes in diff range: $$DIFF_RANGE"; exit 0; fi; \
	echo "$$DIFF" > "$$DIFF_FILE"; \
	SUMMARY=$$(curl -s -X POST http://localhost:9103/summarize-git-diff -H "Content-Type: application/json" -d "{\"diff\":$$(jq -Rs . <<< \"$$DIFF\"),\"concise\":$$CONCISE_FLAG}" | jq -r .combined); \
	META=$$(jq -nc --arg diff_file "$$DIFF_FILE" --arg summary "$$SUMMARY" --arg diff_range "$$DIFF_RANGE" --arg name "$$NAME" --arg project "ai-ide-api" '{diff_file: $$diff_file, summary: $$summary, diff_range: $$diff_range, name: $$name, project: $$project}'); \
	echo "[DEBUG] META: $$META"; \
	python3 scripts/create_memory.py --name "$$NAME" --observation "$$OBSERVATION" --project "ai-ide-api" --namespace "$$NAMESPACE" --meta "$$META";

ai-memory-list-nodes-summary:
	$(MAKE) -f Makefile.ai ai-memory-list-nodes | awk 'f||/^[[]/{f=1;print}' | jq -c '.[] | select(type == "object") | {name: (.meta.name // .name // ""), project: (.meta.project // .project // ""), namespace, created_at, summary: (.meta.summary // null), content}'

.PHONY: ai-memory-utils-build ai-memory-add-node ai-memory-add-edge ai-memory-list-nodes ai-memory-list-edges ai-memory-traverse-single-hop ai-memory-traverse-multi-hop ai-memory-traverse-by-relation ai-memory-export-dot ai-memory-delete-nodes ai-memory-create ai-memory-log-git-diff ai-memory-list-nodes-summary 